{{ 'section-hero-video.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="royal-hero-video section-{{ section.id }}-padding color-{{ section.settings.color_scheme }}">
  <div class="royal-hero-video__media">
    {%- if section.settings.video != blank -%}
      <video
        class="royal-hero-video__video"
        autoplay
        muted
        loop
        playsinline
        poster="{% if section.settings.video_poster != blank %}{{ section.settings.video_poster | image_url }}{% endif %}"
        data-autoplay="{{ section.settings.autoplay }}"
      >
        <source src="{{ section.settings.video.sources[1].url }}" type="{{ section.settings.video.sources[1].mime_type }}">
        <source src="{{ section.settings.video.sources[0].url }}" type="{{ section.settings.video.sources[0].mime_type }}">
      </video>
    {%- elsif section.settings.video_url != blank -%}
      {%- liquid
        assign video_id = section.settings.video_url.id
        assign video_alt = section.settings.video_url.alt | default: shop.name
        assign loop = ''
        if section.settings.enable_video_looping
          assign loop = '&loop=1&playlist=' | append: video_id
        endif
      -%}
      <iframe
        src="https://www.youtube.com/embed/{{ video_id }}?{% if section.settings.autoplay %}autoplay=1&{% endif %}mute=1{{ loop }}&controls=0&showinfo=0&rel=0"
        class="royal-hero-video__iframe js-youtube"
        allow="autoplay; encrypted-media"
        allowfullscreen
        title="{{ video_alt | escape }}"
      ></iframe>
    {%- else -%}
      {%- if section.settings.image != blank -%}
        {%- liquid
          assign image_height = section.settings.image.width | divided_by: section.settings.image.aspect_ratio
        -%}
        <img
          srcset="
            {%- if section.settings.image.width >= 375 -%}{{ section.settings.image | image_url: width: 375 }} 375w,{%- endif -%}
            {%- if section.settings.image.width >= 750 -%}{{ section.settings.image | image_url: width: 750 }} 750w,{%- endif -%}
            {%- if section.settings.image.width >= 1100 -%}{{ section.settings.image | image_url: width: 1100 }} 1100w,{%- endif -%}
            {%- if section.settings.image.width >= 1500 -%}{{ section.settings.image | image_url: width: 1500 }} 1500w,{%- endif -%}
            {%- if section.settings.image.width >= 1780 -%}{{ section.settings.image | image_url: width: 1780 }} 1780w,{%- endif -%}
            {%- if section.settings.image.width >= 2000 -%}{{ section.settings.image | image_url: width: 2000 }} 2000w,{%- endif -%}
            {%- if section.settings.image.width >= 3000 -%}{{ section.settings.image | image_url: width: 3000 }} 3000w,{%- endif -%}
            {%- if section.settings.image.width >= 3840 -%}{{ section.settings.image | image_url: width: 3840 }} 3840w,{%- endif -%}
            {{ section.settings.image | image_url }} {{ section.settings.image.width }}w
          "
          src="{{ section.settings.image | image_url: width: 1500 }}"
          loading="eager"
          sizes="100vw"
          width="{{ section.settings.image.width }}"
          height="{{ image_height }}"
          alt="{{ section.settings.image.alt | escape }}"
          class="royal-hero-video__fallback-image"
        />
      {%- else -%}
        <div class="royal-hero-video__placeholder">
          {{ 'lifestyle-2' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
      {%- endif -%}
    {%- endif -%}
    
    {%- if section.settings.show_overlay -%}
      <div class="royal-hero-video__overlay" style="opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }};"></div>
    {%- endif -%}
  </div>

  <div class="royal-hero-video__content">
    <div class="royal-hero-video__inner page-width">
      {%- if section.settings.heading != blank -%}
        <h1 class="royal-hero-video__heading royal-display" data-reveal="scale-in">
          {{ section.settings.heading }}
        </h1>
      {%- endif -%}
      
      {%- if section.settings.subheading != blank -%}
        <p class="royal-hero-video__subheading royal-heading-3" data-reveal="slide-in-up" data-reveal-delay="200">
          {{ section.settings.subheading }}
        </p>
      {%- endif -%}
      
      {%- if section.settings.description != blank -%}
        <div class="royal-hero-video__description royal-body" data-reveal="fade-in" data-reveal-delay="400">
          {{ section.settings.description }}
        </div>
      {%- endif -%}
      
      {%- if section.settings.button_label != blank -%}
        <div class="royal-hero-video__buttons" data-reveal="slide-in-up" data-reveal-delay="600">
          <a
            {% if section.settings.button_link == blank %}
              role="link" aria-disabled="true"
            {% else %}
              href="{{ section.settings.button_link }}"
            {% endif %}
            class="royal-btn royal-btn--{{ section.settings.button_style }} royal-hero-video__button"
            data-magnetic
          >
            {{ section.settings.button_label | escape }}
            <svg class="royal-btn__arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8.22 2.97a.75.75 0 011.06 0L13.53 7.22a.75.75 0 010 1.06L9.28 12.53a.75.75 0 01-1.06-1.06L11.69 8 8.22 4.53a.75.75 0 010-1.06z"/>
              <path d="M12.25 8a.75.75 0 01-.75.75H2.75a.75.75 0 010-1.5h8.75a.75.75 0 01.75.75z"/>
            </svg>
          </a>
          
          {%- if section.settings.button_label_2 != blank -%}
            <a
              {% if section.settings.button_link_2 == blank %}
                role="link" aria-disabled="true"
              {% else %}
                href="{{ section.settings.button_link_2 }}"
              {% endif %}
              class="royal-btn royal-btn--{{ section.settings.button_style_2 }} royal-hero-video__button"
              data-magnetic
            >
              {{ section.settings.button_label_2 | escape }}
            </a>
          {%- endif -%}
        </div>
      {%- endif -%}
      
      {%- if section.settings.show_scroll_indicator -%}
        <div class="royal-hero-video__scroll-indicator" data-reveal="fade-in" data-reveal-delay="800">
          <span class="royal-caption">Scroll to explore</span>
          <div class="royal-scroll-arrow">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 4V20M12 20L18 14M12 20L6 14"/>
            </svg>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>

  {%- if section.settings.show_floating_elements -%}
    <div class="royal-hero-video__floating-elements">
      <div class="royal-floating-element royal-floating-element--1" data-parallax="0.1"></div>
      <div class="royal-floating-element royal-floating-element--2" data-parallax="0.2"></div>
      <div class="royal-floating-element royal-floating-element--3" data-parallax="0.15"></div>
    </div>
  {%- endif -%}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const heroVideo = document.querySelector('.royal-hero-video');
    if (!heroVideo) return;

    const video = heroVideo.querySelector('.royal-hero-video__video');
    const iframe = heroVideo.querySelector('.royal-hero-video__iframe');

    // Handle video autoplay
    if (video) {
      // Ensure video plays on mobile
      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.catch(() => {
          // Autoplay failed, show play button
          console.log('Autoplay prevented');
        });
      }

      // Pause video when not in viewport to save bandwidth
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            video.play();
          } else {
            video.pause();
          }
        });
      }, { threshold: 0.5 });

      observer.observe(video);
    }

    // Handle YouTube iframe
    if (iframe) {
      iframe.addEventListener('load', function() {
        iframe.classList.add('loaded');
      });
    }

    // Smooth scroll for scroll indicator
    const scrollIndicator = heroVideo.querySelector('.royal-hero-video__scroll-indicator');
    if (scrollIndicator) {
      scrollIndicator.addEventListener('click', function() {
        const nextSection = heroVideo.nextElementSibling;
        if (nextSection) {
          nextSection.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }

    // Performance optimization: reduce quality on slow connections
    if ('connection' in navigator) {
      const connection = navigator.connection;
      if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
        if (video) {
          // Switch to lower quality source if available
          video.style.filter = 'blur(1px)'; // Slight blur to hide compression
        }
      }
    }
  });
</script>

{% schema %}
{
  "name": "Video Hero",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Media"
    },
    {
      "type": "video",
      "id": "video",
      "label": "Video",
      "info": "Upload an MP4 video file. For best performance, keep under 20MB."
    },
    {
      "type": "video_url",
      "id": "video_url",
      "accept": ["youtube", "vimeo"],
      "default": "https://www.youtube.com/watch?v=_9VUPq3SxOc",
      "label": "Video URL",
      "placeholder": "https://www.youtube.com/watch?v=_9VUPq3SxOc",
      "info": "Use YouTube or Vimeo URL if no video file is uploaded"
    },
    {
      "type": "image_picker",
      "id": "video_poster",
      "label": "Video poster image",
      "info": "Shown before video loads"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Fallback image",
      "info": "Shown if video fails to load"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Autoplay video",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_video_looping",
      "label": "Loop video",
      "default": true
    },
    {
      "type": "header",
      "content": "Overlay"
    },
    {
      "type": "checkbox",
      "id": "show_overlay",
      "label": "Show overlay",
      "default": true
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 100,
      "step": 10,
      "unit": "%",
      "label": "Overlay opacity",
      "default": 40
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "default": "Revolutionary Automotive Technology",
      "label": "Heading"
    },
    {
      "type": "inline_richtext",
      "id": "subheading",
      "default": "Experience the future of premium car accessories",
      "label": "Subheading"
    },
    {
      "type": "richtext",
      "id": "description",
      "default": "<p>Discover our cutting-edge automotive solutions designed for discerning drivers who demand excellence in every detail.</p>",
      "label": "Description"
    },
    {
      "type": "text",
      "id": "button_label",
      "default": "Explore Products",
      "label": "Primary button label"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Primary button link"
    },
    {
      "type": "select",
      "id": "button_style",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "metallic",
          "label": "Metallic"
        }
      ],
      "default": "primary",
      "label": "Primary button style"
    },
    {
      "type": "text",
      "id": "button_label_2",
      "label": "Secondary button label"
    },
    {
      "type": "url",
      "id": "button_link_2",
      "label": "Secondary button link"
    },
    {
      "type": "select",
      "id": "button_style_2",
      "options": [
        {
          "value": "primary",
          "label": "Primary"
        },
        {
          "value": "secondary",
          "label": "Secondary"
        },
        {
          "value": "metallic",
          "label": "Metallic"
        }
      ],
      "default": "secondary",
      "label": "Secondary button style"
    },
    {
      "type": "header",
      "content": "Visual Effects"
    },
    {
      "type": "checkbox",
      "id": "show_scroll_indicator",
      "label": "Show scroll indicator",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_floating_elements",
      "label": "Show floating elements",
      "default": true,
      "info": "Decorative animated elements"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Video Hero"
    }
  ]
}
{% endschema %}