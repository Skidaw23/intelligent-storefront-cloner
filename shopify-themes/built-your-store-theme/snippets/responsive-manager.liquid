{% comment %}
==============================================
INTELLIGENT STOREFRONT CLONER - RESPONSIVE MANAGER
==============================================
Advanced responsive design management system.
Handles device detection, breakpoint management, and adaptive loading.

Features:
- Smart device detection
- Breakpoint management
- Lazy loading system
- Performance optimization
- Accessibility features
==============================================
{% endcomment %}

{% liquid
  comment 'Initialize Responsive Manager'
  assign responsive_manager_initialized = true
  assign responsive_debug = settings.debug_mode
  
  comment 'Device Detection'
  assign is_mobile = false
  assign is_tablet = false
  assign is_desktop = true
  
  comment 'Breakpoint System'
  assign breakpoint_mobile = 480
  assign breakpoint_tablet = 768
  assign breakpoint_desktop = 1024
  assign breakpoint_large = 1200
  assign breakpoint_xlarge = 1600
  
  comment 'Performance Settings'
  assign lazy_loading_enabled = true
  assign critical_css_inlined = false
  assign progressive_enhancement = true
%}

{% comment %} RESPONSIVE UTILITY FUNCTIONS {% endcomment %}

{% comment %} Get Responsive Image Sizes {% endcomment %}
{% liquid
  assign get_image_sizes_mobile = get_image_sizes_mobile | default: '100vw'
  assign get_image_sizes_tablet = get_image_sizes_tablet | default: '50vw'
  assign get_image_sizes_desktop = get_image_sizes_desktop | default: '33vw'
  assign responsive_image_sizes = '(max-width: ' | append: breakpoint_mobile | append: 'px) ' | append: get_image_sizes_mobile | append: ', (max-width: ' | append: breakpoint_tablet | append: 'px) ' | append: get_image_sizes_tablet | append: ', ' | append: get_image_sizes_desktop
%}

{% comment %} Generate Responsive Srcset {% endcomment %}
{% liquid
  assign generate_srcset_image = generate_srcset_image | default: blank
  assign generate_srcset_widths = generate_srcset_widths | default: '300,600,900,1200,1500,1800' | split: ','
  assign generated_srcset = blank
  
  if generate_srcset_image != blank
    for width in generate_srcset_widths
      assign width_int = width | plus: 0
      if forloop.first
        assign generated_srcset = generate_srcset_image | image_url: width: width_int | append: ' ' | append: width | append: 'w'
      else
        assign generated_srcset = generated_srcset | append: ', ' | append: generate_srcset_image | image_url: width: width_int | append: ' ' | append: width | append: 'w'
      endif
    endfor
  endif
%}

{% comment %} ADAPTIVE LOADING SYSTEM {% endcomment %}

{% comment %} Critical Resources {% endcomment %}
{% liquid
  assign critical_fonts = 'font-body,font-heading' | split: ','
  assign critical_css = 'base.css,component-button.css,section-header.css' | split: ','
  assign critical_js = 'global.js,theme-architecture-core.js' | split: ','
%}

{% comment %} Non-Critical Resources {% endcomment %}
{% liquid
  assign non_critical_css = 'animations.css,section-footer.css,component-modal.css' | split: ','
  assign non_critical_js = 'animations.js,product-form.js,cart-drawer.js' | split: ','
%}

{% comment %} PERFORMANCE OPTIMIZATION HELPERS {% endcomment %}

{% comment %} Generate Resource Hints {% endcomment %}
{% liquid
  assign preload_resources = blank
  assign prefetch_resources = blank
  assign preconnect_domains = 'fonts.shopifycdn.com,cdn.shopify.com' | split: ','
%}

{% comment %} Lazy Loading Implementation {% endcomment %}
{% liquid
  assign lazy_load_threshold = '100px'
  assign lazy_load_placeholder = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMSIgaGVpZ2h0PSIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InJnYmEoMCwwLDAsMC4xKSIvPjwvc3ZnPg=='
  assign intersection_observer_supported = true
%}

{% comment %} IMAGE OPTIMIZATION FUNCTIONS {% endcomment %}

{% comment %} Generate Picture Element {% endcomment %}
{% liquid
  assign picture_desktop_image = picture_desktop_image | default: blank
  assign picture_mobile_image = picture_mobile_image | default: blank
  assign picture_alt_text = picture_alt_text | default: ''
  assign picture_class = picture_class | default: 'responsive-picture'
  assign picture_loading = picture_loading | default: 'lazy'
  assign picture_sizes = picture_sizes | default: '100vw'
%}

{% comment %} Responsive Background Images {% endcomment %}
{% liquid
  assign bg_image_desktop = bg_image_desktop | default: blank
  assign bg_image_tablet = bg_image_tablet | default: blank
  assign bg_image_mobile = bg_image_mobile | default: blank
  assign bg_css_custom_properties = blank
%}

{% comment %} VIDEO OPTIMIZATION {% endcomment %}

{% comment %} Responsive Video Setup {% endcomment %}
{% liquid
  assign video_desktop = video_desktop | default: blank
  assign video_mobile = video_mobile | default: blank
  assign video_poster = video_poster | default: blank
  assign video_autoplay = video_autoplay | default: false
  assign video_loop = video_loop | default: true
  assign video_muted = video_muted | default: true
  assign video_preload = video_preload | default: 'metadata'
%}

{% comment %} ACCESSIBILITY RESPONSIVE FEATURES {% endcomment %}

{% comment %} Screen Reader Utilities {% endcomment %}
{% liquid
  assign sr_only_class = 'sr-only'
  assign skip_link_enabled = true
  assign focus_management = true
%}

{% comment %} Reduced Motion Preferences {% endcomment %}
{% liquid
  assign respect_reduced_motion = true
  assign animation_duration = 300
  assign transition_easing = 'ease-out'
%}

{% comment %} RESPONSIVE BREAKPOINT UTILITIES {% endcomment %}

<style>
  /* Responsive Manager Core Styles */
  :root {
    --breakpoint-mobile: {{ breakpoint_mobile }}px;
    --breakpoint-tablet: {{ breakpoint_tablet }}px;
    --breakpoint-desktop: {{ breakpoint_desktop }}px;
    --breakpoint-large: {{ breakpoint_large }}px;
    --breakpoint-xlarge: {{ breakpoint_xlarge }}px;
    --responsive-manager-version: "1.0.0";
  }

  /* Responsive Utility Classes */
  .responsive-manager {
    --container-padding: 1rem;
    --container-max-width: 1200px;
  }

  .container {
    width: 100%;
    max-width: var(--container-max-width);
    margin: 0 auto;
    padding-left: var(--container-padding);
    padding-right: var(--container-padding);
  }

  .container--fluid {
    max-width: none;
  }

  .container--narrow {
    max-width: 768px;
  }

  .container--wide {
    max-width: 1400px;
  }

  /* Responsive Grid System */
  .responsive-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }

  @media (min-width: 480px) {
    .responsive-grid--mobile-2 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 768px) {
    .responsive-grid {
      gap: 1.5rem;
    }
    
    .responsive-grid--tablet-2 {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .responsive-grid--tablet-3 {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .responsive-grid {
      gap: 2rem;
    }
    
    .responsive-grid--desktop-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    
    .responsive-grid--desktop-4 {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Responsive Typography */
  .responsive-text {
    font-size: clamp(1rem, 2.5vw, 1.25rem);
    line-height: 1.5;
  }

  .responsive-heading {
    font-size: clamp(1.5rem, 4vw, 3rem);
    line-height: 1.2;
  }

  /* Responsive Images */
  .responsive-image {
    max-width: 100%;
    height: auto;
    display: block;
  }

  .responsive-image--lazy {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .responsive-image--lazy.loaded {
    opacity: 1;
  }

  .responsive-picture {
    display: block;
    width: 100%;
  }

  .responsive-picture img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Responsive Video */
  .responsive-video {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    overflow: hidden;
  }

  .responsive-video iframe,
  .responsive-video video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  /* Visibility Utilities */
  .show-mobile {
    display: block;
  }

  .show-tablet,
  .show-desktop {
    display: none;
  }

  @media (min-width: 768px) {
    .show-mobile {
      display: none;
    }
    
    .show-tablet {
      display: block;
    }
    
    .hide-tablet {
      display: none;
    }
  }

  @media (min-width: 1024px) {
    .show-tablet {
      display: none;
    }
    
    .show-desktop {
      display: block;
    }
    
    .hide-desktop {
      display: none;
    }
  }

  /* Accessibility Utilities */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    background: rgb(var(--color-background));
    color: rgb(var(--color-foreground));
    padding: 8px 16px;
    text-decoration: none;
    border-radius: 4px;
    z-index: 9999;
    transition: top 0.2s ease;
  }

  .skip-link:focus {
    top: 6px;
  }

  /* Reduced Motion Support */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
    
    .responsive-image--lazy {
      transition: none;
    }
  }

  /* High Contrast Support */
  @media (prefers-contrast: high) {
    .responsive-image--lazy {
      opacity: 1;
    }
  }

  /* Print Styles */
  @media print {
    .hide-print {
      display: none;
    }
    
    .responsive-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .responsive-image,
    .responsive-picture img {
      page-break-inside: avoid;
    }
  }
</style>

{% comment %} RESPONSIVE MANAGER JAVASCRIPT {% endcomment %}
<script>
  // Responsive Manager Core
  window.ResponsiveManager = {
    breakpoints: {
      mobile: {{ breakpoint_mobile }},
      tablet: {{ breakpoint_tablet }},
      desktop: {{ breakpoint_desktop }},
      large: {{ breakpoint_large }},
      xlarge: {{ breakpoint_xlarge }}
    },
    
    // Get current breakpoint
    getCurrentBreakpoint: function() {
      const width = window.innerWidth;
      if (width < this.breakpoints.mobile) return 'xs';
      if (width < this.breakpoints.tablet) return 'mobile';
      if (width < this.breakpoints.desktop) return 'tablet';
      if (width < this.breakpoints.large) return 'desktop';
      return 'large';
    },
    
    // Device detection
    isMobile: function() {
      return window.innerWidth < this.breakpoints.tablet;
    },
    
    isTablet: function() {
      return window.innerWidth >= this.breakpoints.tablet && window.innerWidth < this.breakpoints.desktop;
    },
    
    isDesktop: function() {
      return window.innerWidth >= this.breakpoints.desktop;
    },
    
    // Lazy loading implementation
    lazyLoad: function() {
      const images = document.querySelectorAll('.responsive-image--lazy');
      
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const image = entry.target;
              if (image.dataset.src) {
                image.src = image.dataset.src;
              }
              if (image.dataset.srcset) {
                image.srcset = image.dataset.srcset;
              }
              image.classList.add('loaded');
              image.classList.remove('responsive-image--lazy');
              observer.unobserve(image);
            }
          });
        }, {
          rootMargin: '{{ lazy_load_threshold }}'
        });
        
        images.forEach(image => imageObserver.observe(image));
      } else {
        // Fallback for browsers without IntersectionObserver
        images.forEach(image => {
          if (image.dataset.src) {
            image.src = image.dataset.src;
          }
          if (image.dataset.srcset) {
            image.srcset = image.dataset.srcset;
          }
          image.classList.add('loaded');
          image.classList.remove('responsive-image--lazy');
        });
      }
    },
    
    // Responsive video handling
    initResponsiveVideos: function() {
      const videos = document.querySelectorAll('.responsive-video video');
      videos.forEach(video => {
        if (this.isMobile() && video.dataset.mobileSrc) {
          video.src = video.dataset.mobileSrc;
        }
        
        // Handle autoplay on mobile
        if (this.isMobile() && video.hasAttribute('autoplay')) {
          video.muted = true; // Required for autoplay on mobile
        }
      });
    },
    
    // Performance monitoring
    monitor: function() {
      if ('PerformanceObserver' in window) {
        // Monitor largest contentful paint
        const lcpObserver = new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          if (window.gtag) {
            gtag('event', 'LCP', {
              event_category: 'Performance',
              event_label: 'Largest Contentful Paint',
              value: Math.round(lastEntry.startTime)
            });
          }
        });
        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
      }
    },
    
    // Initialize all responsive features
    init: function() {
      // Set CSS custom properties
      document.documentElement.style.setProperty('--current-breakpoint', this.getCurrentBreakpoint());
      document.documentElement.style.setProperty('--is-mobile', this.isMobile() ? '1' : '0');
      document.documentElement.style.setProperty('--is-tablet', this.isTablet() ? '1' : '0');
      document.documentElement.style.setProperty('--is-desktop', this.isDesktop() ? '1' : '0');
      
      // Initialize lazy loading
      this.lazyLoad();
      
      // Initialize responsive videos
      this.initResponsiveVideos();
      
      // Start performance monitoring
      {% if responsive_debug %}
        this.monitor();
      {% endif %}
      
      // Update on resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          document.documentElement.style.setProperty('--current-breakpoint', this.getCurrentBreakpoint());
          document.documentElement.style.setProperty('--is-mobile', this.isMobile() ? '1' : '0');
          document.documentElement.style.setProperty('--is-tablet', this.isTablet() ? '1' : '0');
          document.documentElement.style.setProperty('--is-desktop', this.isDesktop() ? '1' : '0');
        }, 250);
      });
    }
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => ResponsiveManager.init());
  } else {
    ResponsiveManager.init();
  }
  
  {% if responsive_debug %}
    console.log('📱 Responsive Manager Loaded');
    console.log('📐 Breakpoints:', ResponsiveManager.breakpoints);
    console.log('📱 Current Device:', ResponsiveManager.getCurrentBreakpoint());
    console.log('⚡ Lazy Loading:', {{ lazy_loading_enabled }});
  {% endif %}
</script>

{% comment %} RESOURCE PRELOADING {% endcomment %}
{% for domain in preconnect_domains %}
  <link rel="preconnect" href="https://{{ domain }}" crossorigin>
{% endfor %}

{% comment %} SKIP LINKS FOR ACCESSIBILITY {% endcomment %}
{% if skip_link_enabled %}
  <a href="#main-content" class="skip-link">{{ 'accessibility.skip_to_content' | t | default: 'Skip to content' }}</a>
{% endif %}

{% comment %} DEBUG INFORMATION {% endcomment %}
{% if responsive_debug %}
  <div class="responsive-debug" style="position: fixed; top: 10px; right: 10px; background: #333; color: #fff; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 12px; z-index: 9999; max-width: 200px;">
    <strong>📱 Responsive Manager</strong><br>
    Breakpoint: <span id="current-breakpoint">-</span><br>
    Width: <span id="current-width">-</span>px<br>
    Device: <span id="current-device">-</span><br>
    Version: 1.0.0
  </div>
  
  <script>
    function updateDebugInfo() {
      const debugEl = document.querySelector('.responsive-debug');
      if (debugEl) {
        debugEl.querySelector('#current-breakpoint').textContent = ResponsiveManager.getCurrentBreakpoint();
        debugEl.querySelector('#current-width').textContent = window.innerWidth;
        debugEl.querySelector('#current-device').textContent = ResponsiveManager.isMobile() ? 'Mobile' : ResponsiveManager.isTablet() ? 'Tablet' : 'Desktop';
      }
    }
    
    window.addEventListener('resize', updateDebugInfo);
    setTimeout(updateDebugInfo, 100);
  </script>
{% endif %}