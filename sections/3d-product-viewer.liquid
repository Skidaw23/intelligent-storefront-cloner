{{ '3d-product-viewer.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<div class="royal-3d-showcase section-{{ section.id }}-padding color-{{ section.settings.color_scheme }}">
  <div class="page-width">
    {%- if section.settings.heading != blank or section.settings.description != blank -%}
      <div class="royal-3d-showcase__header" data-reveal="fade-in">
        {%- if section.settings.heading != blank -%}
          <h2 class="royal-heading-1 royal-3d-showcase__heading">
            {{ section.settings.heading }}
          </h2>
        {%- endif -%}
        
        {%- if section.settings.description != blank -%}
          <div class="royal-body royal-3d-showcase__description">
            {{ section.settings.description }}
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}

    <div class="royal-3d-showcase__content">
      <div class="royal-3d-showcase__grid royal-grid royal-grid--2">
        
        {%- comment -%} 3D Viewer {%- endcomment -%}
        <div class="royal-3d-showcase__viewer-container" data-reveal="slide-in-left">
          <div class="royal-3d-viewer" id="viewer-{{ section.id }}">
            {%- if section.settings.model_3d != blank -%}
              <model-viewer
                class="royal-3d-model"
                src="{{ section.settings.model_3d | model_viewer_url }}"
                poster="{% if section.settings.model_poster != blank %}{{ section.settings.model_poster | image_url: width: 800 }}{% endif %}"
                alt="{{ section.settings.model_alt | default: 'Interactive 3D model' }}"
                shadow-intensity="{{ section.settings.shadow_intensity | divided_by: 100.0 }}"
                camera-controls
                {% if section.settings.enable_ar %}ar{% endif %}
                {% if section.settings.auto_rotate %}auto-rotate{% endif %}
                {% if section.settings.disable_zoom == false %}touch-action="pan-y"{% endif %}
                environment-image="{% if section.settings.environment_image != blank %}{{ section.settings.environment_image | image_url }}{% else %}neutral{% endif %}"
                exposure="{{ section.settings.exposure | divided_by: 100.0 }}"
                camera-orbit="{{ section.settings.camera_orbit_theta }}deg {{ section.settings.camera_orbit_phi }}deg {{ section.settings.camera_orbit_radius }}%"
                field-of-view="{{ section.settings.field_of_view }}deg"
                min-camera-orbit="auto {{ section.settings.min_camera_orbit_phi }}deg auto"
                max-camera-orbit="auto {{ section.settings.max_camera_orbit_phi }}deg auto"
                min-field-of-view="{{ section.settings.min_fov }}deg"
                max-field-of-view="{{ section.settings.max_fov }}deg"
                interaction-prompt="{{ section.settings.interaction_prompt }}"
                loading="eager"
              >
                {%- if section.settings.enable_ar -%}
                  <button class="royal-ar-button" slot="ar-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/>
                    </svg>
                    View in AR
                  </button>
                {%- endif -%}

                <div class="royal-3d-loading" slot="poster">
                  <div class="royal-loading-ring"></div>
                  <p class="royal-caption">Loading 3D Model...</p>
                </div>

                <div class="royal-3d-error" slot="error">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <p>Unable to load 3D model</p>
                  <p class="royal-caption">Please check your connection</p>
                </div>
              </model-viewer>
            {%- else -%}
              <div class="royal-3d-placeholder">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <p class="royal-heading-3">3D Model Placeholder</p>
                <p class="royal-caption">Upload a 3D model to showcase your product</p>
              </div>
            {%- endif -%}

            {%- if section.settings.show_hotspots -%}
              <div class="royal-3d-hotspots">
                {%- for block in section.blocks -%}
                  {%- case block.type -%}
                    {%- when 'hotspot' -%}
                      <div class="royal-hotspot"
                           data-position="{{ block.settings.position_x }},{{ block.settings.position_y }},{{ block.settings.position_z }}"
                           data-normal="{{ block.settings.normal_x }},{{ block.settings.normal_y }},{{ block.settings.normal_z }}"
                           style="--hotspot-color: {{ block.settings.hotspot_color }};">
                        <div class="royal-hotspot-button" data-hotspot-id="{{ block.id }}">
                          <div class="royal-hotspot-pulse"></div>
                        </div>
                        <div class="royal-hotspot-content" id="hotspot-content-{{ block.id }}">
                          {%- if block.settings.title != blank -%}
                            <h4 class="royal-hotspot-title">{{ block.settings.title }}</h4>
                          {%- endif -%}
                          {%- if block.settings.description != blank -%}
                            <p class="royal-hotspot-description">{{ block.settings.description }}</p>
                          {%- endif -%}
                          {%- if block.settings.link_url != blank and block.settings.link_text != blank -%}
                            <a href="{{ block.settings.link_url }}" class="royal-hotspot-link">
                              {{ block.settings.link_text }}
                              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8.22 2.97a.75.75 0 011.06 0L13.53 7.22a.75.75 0 010 1.06L9.28 12.53a.75.75 0 01-1.06-1.06L11.69 8 8.22 4.53a.75.75 0 010-1.06z"/>
                              </svg>
                            </a>
                          {%- endif -%}
                        </div>
                      </div>
                  {%- endcase -%}
                {%- endfor -%}
              </div>
            {%- endif -%}

            <div class="royal-3d-controls">
              <button class="royal-3d-control" data-action="reset">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                <span class="royal-caption">Reset</span>
              </button>
              
              {%- if section.settings.show_wireframe_toggle -%}
                <button class="royal-3d-control" data-action="wireframe">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11.5-9.5h3v3h-3v-3zM15 7h5v3h-5V7zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
                  </svg>
                  <span class="royal-caption">Wireframe</span>
                </button>
              {%- endif -%}
              
              <button class="royal-3d-control" data-action="fullscreen">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                <span class="royal-caption">Fullscreen</span>
              </button>
            </div>
          </div>
        </div>

        {%- comment -%} Product Information {%- endcomment -%}
        <div class="royal-3d-showcase__info" data-reveal="slide-in-right" data-reveal-delay="200">
          {%- if section.settings.product != blank -%}
            {%- assign product = section.settings.product -%}
            
            <div class="royal-product-info">
              <h3 class="royal-heading-2 royal-product-info__title">
                {{ product.title }}
              </h3>
              
              <div class="royal-product-info__price">
                {% render 'price', product: product, use_variant: true, show_badges: true %}
              </div>
              
              {%- if product.description != blank -%}
                <div class="royal-product-info__description royal-body">
                  {{ product.description | truncate: 200 }}
                </div>
              {%- endif -%}
              
              <div class="royal-product-info__features">
                {%- if section.settings.feature_1_icon != blank or section.settings.feature_1_text != blank -%}
                  <div class="royal-feature">
                    {%- if section.settings.feature_1_icon != blank -%}
                      <div class="royal-feature__icon">
                        {{ section.settings.feature_1_icon | image_url: width: 32 | image_tag }}
                      </div>
                    {%- endif -%}
                    <span class="royal-feature__text">{{ section.settings.feature_1_text }}</span>
                  </div>
                {%- endif -%}
                
                {%- if section.settings.feature_2_icon != blank or section.settings.feature_2_text != blank -%}
                  <div class="royal-feature">
                    {%- if section.settings.feature_2_icon != blank -%}
                      <div class="royal-feature__icon">
                        {{ section.settings.feature_2_icon | image_url: width: 32 | image_tag }}
                      </div>
                    {%- endif -%}
                    <span class="royal-feature__text">{{ section.settings.feature_2_text }}</span>
                  </div>
                {%- endif -%}
                
                {%- if section.settings.feature_3_icon != blank or section.settings.feature_3_text != blank -%}
                  <div class="royal-feature">
                    {%- if section.settings.feature_3_icon != blank -%}
                      <div class="royal-feature__icon">
                        {{ section.settings.feature_3_icon | image_url: width: 32 | image_tag }}
                      </div>
                    {%- endif -%}
                    <span class="royal-feature__text">{{ section.settings.feature_3_text }}</span>
                  </div>
                {%- endif -%}
              </div>
              
              {%- if section.settings.show_add_to_cart -%}
                <div class="royal-product-info__actions">
                  <form action="/cart/add" method="post" enctype="multipart/form-data" class="royal-product-form">
                    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                    
                    <button type="submit" class="royal-btn royal-btn--primary royal-btn--full-width" data-magnetic>
                      <span>Add to Cart - {{ product.selected_or_first_available_variant.price | money }}</span>
                      <svg class="royal-btn__icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7ZM9 3V4H15V3H9ZM7 6V19H17V6H7Z"/>
                      </svg>
                    </button>
                    
                    {%- if section.settings.button_text_2 != blank -%}
                      <a href="{{ product.url }}" class="royal-btn royal-btn--secondary royal-btn--full-width">
                        {{ section.settings.button_text_2 }}
                      </a>
                    {%- endif -%}
                  </form>
                </div>
              {%- endif -%}
            </div>
          {%- else -%}
            <div class="royal-3d-showcase__content-placeholder">
              <h3 class="royal-heading-2">Premium Product Showcase</h3>
              <p class="royal-body">Connect a product to display detailed information alongside the 3D model.</p>
              <div class="royal-placeholder-features">
                <div class="royal-feature">
                  <div class="royal-feature__icon">üîß</div>
                  <span class="royal-feature__text">Precision Engineering</span>
                </div>
                <div class="royal-feature">
                  <div class="royal-feature__icon">‚ö°</div>
                  <span class="royal-feature__text">Advanced Technology</span>
                </div>
                <div class="royal-feature">
                  <div class="royal-feature__icon">üèÜ</div>
                  <span class="royal-feature__text">Premium Quality</span>
                </div>
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { RoyalThreeDViewer } from '{{ 'royal-3d-viewer.js' | asset_url }}';
  
  document.addEventListener('DOMContentLoaded', function() {
    const viewer = new RoyalThreeDViewer('#viewer-{{ section.id }}', {
      autoRotateDelay: {{ section.settings.auto_rotate_delay }},
      hotspots: {{ section.settings.show_hotspots | json }},
      enableAnalytics: true
    });
  });
</script>

{% schema %}
{
  "name": "3D Product Viewer",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "default": "Experience in 3D",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "description",
      "default": "<p>Interact with our products in stunning 3D detail. Rotate, zoom, and explore every angle.</p>",
      "label": "Description"
    },
    {
      "type": "header",
      "content": "3D Model"
    },
    {
      "type": "model",
      "id": "model_3d",
      "label": "3D Model",
      "info": "Upload a GLB or GLTF file for interactive viewing"
    },
    {
      "type": "image_picker",
      "id": "model_poster",
      "label": "Model poster image",
      "info": "Shown while 3D model loads"
    },
    {
      "type": "text",
      "id": "model_alt",
      "label": "Model alt text",
      "default": "Interactive 3D product model"
    },
    {
      "type": "header",
      "content": "3D Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_ar",
      "label": "Enable AR viewing",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto-rotate model",
      "default": true
    },
    {
      "type": "range",
      "id": "auto_rotate_delay",
      "min": 1000,
      "max": 10000,
      "step": 500,
      "unit": "ms",
      "label": "Auto-rotate delay",
      "default": 3000
    },
    {
      "type": "checkbox",
      "id": "disable_zoom",
      "label": "Disable zoom",
      "default": false
    },
    {
      "type": "range",
      "id": "shadow_intensity",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Shadow intensity",
      "default": 50
    },
    {
      "type": "range",
      "id": "exposure",
      "min": 50,
      "max": 200,
      "step": 5,
      "unit": "%",
      "label": "Lighting exposure",
      "default": 100
    },
    {
      "type": "header",
      "content": "Camera Settings"
    },
    {
      "type": "range",
      "id": "camera_orbit_theta",
      "min": -180,
      "max": 180,
      "step": 5,
      "unit": "¬∞",
      "label": "Initial horizontal angle",
      "default": 0
    },
    {
      "type": "range",
      "id": "camera_orbit_phi",
      "min": 0,
      "max": 180,
      "step": 5,
      "unit": "¬∞",
      "label": "Initial vertical angle",
      "default": 90
    },
    {
      "type": "range",
      "id": "camera_orbit_radius",
      "min": 100,
      "max": 300,
      "step": 10,
      "unit": "%",
      "label": "Initial zoom level",
      "default": 150
    },
    {
      "type": "range",
      "id": "field_of_view",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "¬∞",
      "label": "Field of view",
      "default": 45
    },
    {
      "type": "range",
      "id": "min_camera_orbit_phi",
      "min": 0,
      "max": 90,
      "step": 5,
      "unit": "¬∞",
      "label": "Min vertical angle",
      "default": 30
    },
    {
      "type": "range",
      "id": "max_camera_orbit_phi",
      "min": 90,
      "max": 180,
      "step": 5,
      "unit": "¬∞",
      "label": "Max vertical angle",
      "default": 150
    },
    {
      "type": "range",
      "id": "min_fov",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "¬∞",
      "label": "Minimum FOV",
      "default": 20
    },
    {
      "type": "range",
      "id": "max_fov",
      "min": 50,
      "max": 120,
      "step": 5,
      "unit": "¬∞",
      "label": "Maximum FOV",
      "default": 75
    },
    {
      "type": "select",
      "id": "interaction_prompt",
      "options": [
        {
          "value": "auto",
          "label": "Auto"
        },
        {
          "value": "when-focused",
          "label": "When focused"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "auto",
      "label": "Interaction prompt"
    },
    {
      "type": "header",
      "content": "Hotspots"
    },
    {
      "type": "checkbox",
      "id": "show_hotspots",
      "label": "Show interactive hotspots",
      "default": false
    },
    {
      "type": "header",
      "content": "Product Information"
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "checkbox",
      "id": "show_add_to_cart",
      "label": "Show add to cart button",
      "default": true
    },
    {
      "type": "text",
      "id": "button_text_2",
      "label": "Secondary button text",
      "default": "View Details"
    },
    {
      "type": "header",
      "content": "Features"
    },
    {
      "type": "image_picker",
      "id": "feature_1_icon",
      "label": "Feature 1 icon"
    },
    {
      "type": "text",
      "id": "feature_1_text",
      "label": "Feature 1 text",
      "default": "Precision Engineering"
    },
    {
      "type": "image_picker",
      "id": "feature_2_icon",
      "label": "Feature 2 icon"
    },
    {
      "type": "text",
      "id": "feature_2_text",
      "label": "Feature 2 text",
      "default": "Advanced Materials"
    },
    {
      "type": "image_picker",
      "id": "feature_3_icon",
      "label": "Feature 3 icon"
    },
    {
      "type": "text",
      "id": "feature_3_text",
      "label": "Feature 3 text",
      "default": "Premium Quality"
    },
    {
      "type": "header",
      "content": "Controls"
    },
    {
      "type": "checkbox",
      "id": "show_wireframe_toggle",
      "label": "Show wireframe toggle",
      "default": false
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "background-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 80
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "3D Hotspot",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Hotspot title",
          "default": "Feature Point"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Discover this amazing feature in detail."
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link text"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        },
        {
          "type": "color",
          "id": "hotspot_color",
          "label": "Hotspot color",
          "default": "#00bfff"
        },
        {
          "type": "header",
          "content": "3D Position (advanced)"
        },
        {
          "type": "text",
          "id": "position_x",
          "label": "X position",
          "default": "0"
        },
        {
          "type": "text",
          "id": "position_y",
          "label": "Y position",
          "default": "0"
        },
        {
          "type": "text",
          "id": "position_z",
          "label": "Z position",
          "default": "0"
        },
        {
          "type": "text",
          "id": "normal_x",
          "label": "Normal X",
          "default": "0"
        },
        {
          "type": "text",
          "id": "normal_y",
          "label": "Normal Y",
          "default": "1"
        },
        {
          "type": "text",
          "id": "normal_z",
          "label": "Normal Z",
          "default": "0"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Product Viewer"
    }
  ]
}
{% endschema %}